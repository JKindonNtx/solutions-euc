version: "2"

name: End User Computing (EUC) Benchmark Test

summary: |
  Performs an EUC benchmark test on a specified Nutanix Cloud Infrastructure (NCI) Cluster.

estimated_runtime: {{ _estimatedRunTime }}

variables:
- name: _estimatedRunTime
  string:
    default_value: "3h"
- name: _powerWait
  integer:
    default_value: 30
- name: _workloadPhase
  integer:
    default_value: 1800
- name: C_numberOfNodes
  display_name: "Number of Nodes"
  description: |
    The number of Nutanix Nodes to run the benchmark test against..
  string:
    default_value: "all"
    choices:
      - "1"
      - "2"
      - "3"
      - "4"
- name: D_templateName
  display_name: "Master Image Template."
  description: |
    The file name for the .VMDK file uploaded to XRay to use as a basis for the master image creation process excluding the VMDK extension.
  string:
    default_value: "win10-euc-xray"
- name: E_numberOfVMs
  display_name: "Number of Virtual Machines"
  description: |
    The number of virtual machines to deploy for the benchmark. 
    Please note that these will be deployed in groups to eliminate 
    overloading the cluster and ramp up the workload.
  integer:
    default_value: 30
    minimum_value: 1
- name: F_virtualCPUs
  display_name: "Number of Virtual CPUs"
  description: |
    The number of virtual CPUs to assign to the workload machines created from the master image.
  integer:
    default_value: 2
    choices:
      - 3
      - 4
      - 5
      - 6
      - 7
      - 8
- name: G_virtualMemory
  display_name: "Amount of Memory (GB)"
  description: |
    The amount of memory (in GB) to assign to the workload machines created from the master image.
  string:
    default_value: "4g"
    choices:
    - "2g"
    - "4g"
    - "6g"
    - "8g"
    - "10g"
    - "12g"
    - "14g"
    - "16g"
- name: H_workloadsPerStep
  display_name: "Number of simultaneous workloads per VM Group"
  description: |
    The number of workload VMs to deploy per VM group to ramp the test up to full capacity We advise 5 workloads per node.
  integer:
    default_value: 5
    minimum_value: 1
- name: I_testDuration
  display_name: "Steady State in Minutes"
  description: "The runtime of the End User Computing workload in minutes."
  integer:
    default_value: 20
    minimum_value: 1
- name: J_settleTime
  display_name: "Wait Time in Minutes Before Starting the Test Run"
  description: |
    The number of minutes to wait after VM deployment to start the test.
  integer:
    default_value: 5
    minimum_value: 1
- name: K_nutanixCvmUser
  display_name: "CVM User Name."
  description: |
    The Nutanix CVM User Name.
  string:
    default_value: "nutanix"
- name: L_nutanixCvmPassword
  display_name: "CVM Password."
  description: |
    The Nutanix CVM Password.
  string:
    default_value: "nutanix/4u"
  secret: true
- name: M_windowsUser
  display_name: "Windows User Name."
  description: |
    The Windows User Name.
  string:
    default_value: "nutanix"
- name: N_windowsPassword
  display_name: "Windows Password."
  description: |
    The Windows Password.
  string:
    default_value: "nutanix/4u"
  secret: true
- name: O_runMicrosoftOffice
  display_name: "Run Microsoft Office Apps"
  description: |
    Run the Microsoft Office application tests as part of the benchmark test. 
    Ensure that you have sufficient licensing to be able to run these applications prior to selecting this option.
  boolean:
    default_value: True

{%- set settleTime = (J_settleTime * 60) %}
{%- set rampGroups = (E_numberOfVMs / H_workloadsPerStep) | int %}
{%- set waitTime = (_workloadPhase / rampGroups) | int %}
{%- set testDuration = (I_testDuration * 60) %}
{%- set countPerCluster = (E_numberOfVMs / rampGroups) | int %}


vm_groups:
{%- for step_num in range(rampGroups) %}
- name: Workload Group {{ step_num }}
  template: {{ D_templateName }}
  vcpu_count: {{ F_virtualCPUs }}
  ram: {{ G_virtualMemory }}
  nodes: {{ C_numberOfNodes }}
  count_per_cluster: {{ countPerCluster }}
  exporter_ports:
    - 9182
    - 5555
{%- endfor %}

results:
- name: "7Zip Benchmark average MIPS"
  prometheus:
    aggregation: mean
    unit: count
    phases:
      - Run
    query: |
        zip_benchmark{
          __curie_filter_scenario__,
          score="rating_mips"
        }
- name: Cluster CPU Usage
  hypervisor:
    metric: CpuUsage.Avg.Megahertz
    aggregation: sum
    phases:
    - Run

phases:
- name: Setup
  steps:
  - name: cluster.CleanUp
  - name: playbook.Run
    args:
      filename: disable-cluster-ads.yml
      inventory:
        - cvms
      remote_user: {{ K_nutanixCvmUser }}
      remote_pass: {{ L_nutanixCvmPassword }}
{%- for step_num in range(rampGroups) %}
  - name: vm_group.CloneFromTemplate
    args:
      vm_group_name: Workload Group {{ step_num }}
  - name: vm_group.PowerOnVMs
    args:
      vm_group_name: Workload Group {{ step_num }}
  - name: vm_group.WaitForPowerOnVMs
    args:
      vm_group_name: Workload Group {{ step_num }}
{%- endfor %}
  - name: test.Wait
    args:
      duration_secs: {{ _powerWait }}
{%- for step_num in range(rampGroups) %}
  - name: vm_group.WaitForVMIPAssignment
    args:
      vm_group_name: Workload Group {{ step_num }}
{%- endfor %}
  - name: test.Wait
    args:
      duration_secs: {{ _powerWait }}
{%- for step_num in range(rampGroups) %}
  - name: playbook.Run
    args:
      filename: configure-base.yml
      inventory:
        - Workload Group {{ step_num }}
      variables:
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_winrm_server_cert_validation: ignore
      remote_user: {{ M_windowsUser }}
      remote_pass: {{ N_windowsPassword }}
{%- endfor %}
  - name: test.Wait
    args:
      duration_secs: {{ settleTime }}
      annotate: True
- name: Run
  steps:
{%- for step_num in range(rampGroups) %}
  - name: playbook.Run
    args:
      filename: vm-workload.yml
      inventory:
        - Workload Group {{ step_num }}
      variables:
        ansible_connection: winrm
        ansible_winrm_transport: basic
        ansible_winrm_server_cert_validation: ignore
      remote_user: {{ M_windowsUser }}
      remote_pass: {{ N_windowsPassword }}
  - name: test.Wait
    args:
      duration_secs: {{ waitTime }}
{%- endfor %}
  - name: test.Wait
    args:
      duration_secs: {{ testDuration }}
      annotate: True

- name: Teardown
  steps:
{%- for step_num in range(rampGroups) %}
  - name: vm_group.PowerOff
    args:
      vm_group_name: Workload Group {{ step_num }}
{%- endfor %}
  - name: playbook.Run
    args:
      filename: enable-cluster-ads.yml
      inventory:
        - cvms
      remote_user: {{ K_nutanixCvmUser }}
      remote_pass: {{ L_nutanixCvmPassword }}
  - name: cluster.CleanUp
